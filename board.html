<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Board</title>
  <link rel="stylesheet" href="styles.css">
  <script src="data.js"></script>
<script>
  // Render entries from data.js, localStorage, and Netlify function
  function escapeHtml(str) {
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  function renderList(listEl, items) {
    function formatDate(isoStr) {
      if (!isoStr) return '';
      try {
        const date = new Date(isoStr);
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
      } catch {
        return '';
      }
    }

    listEl.innerHTML = '';
    items.forEach(e => {
      const li = document.createElement('li');
      const timestamp = formatDate(e.created_at);
      li.innerHTML = `<div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 16px; margin-bottom: 8px;">
        <div>
          <strong>${escapeHtml(e.name)}</strong> – <span class="location">${escapeHtml(e.location)}</span>
        </div>
        ${timestamp ? `<div style="color: white; font-size: 0.85em; white-space: nowrap; text-align: right;">${timestamp}</div>` : ''}
      </div>
      ${e.message ? `<div class="meta">${escapeHtml(e.message)}</div>` : ''}`;
      listEl.appendChild(li);
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    const listEl = document.querySelector('.entries');

    // Start with bundled static entries from data.js (if present)
    const staticEntries = (typeof entries !== 'undefined' && Array.isArray(entries)) ? entries.slice() : [];

    // Local entries saved immediately after signing
    const localEntries = JSON.parse(localStorage.getItem('guestbook-local') || '[]');

    // Merge local first so new submissions appear at top
    let merged = [].concat(localEntries, staticEntries);

    // Simple dedupe helper
    const seen = new Set();
    merged = merged.filter(item => {
      const key = `${item.name}||${item.location}||${item.message}`;
      if (seen.has(key)) return false;
      seen.add(key);
      return true;
    });

    // Sort by most recent first
    merged.sort((a, b) => {
      const dateA = a.created_at ? new Date(a.created_at).getTime() : 0;
      const dateB = b.created_at ? new Date(b.created_at).getTime() : 0;
      return dateB - dateA;
    });

    renderList(listEl, merged);

    // Try to fetch live submissions from Netlify function (if deployed)
    // Try to fetch live submissions from Netlify function (if deployed)
    fetch('/.netlify/functions/get-submissions')
      .then(r => { 
        if (!r.ok) {
          console.warn('Function returned status:', r.status);
          throw new Error('not ok'); 
        }
        return r.json(); 
      })
      .then(remote => {
        console.log('Fetched remote submissions:', remote);
        if (!Array.isArray(remote)) {
          console.warn('Remote data is not an array');
          return;
        }
        const combined = [].concat(localEntries, remote, staticEntries);
        // dedupe again
        const s = new Set();
        let finalList = combined.filter(item => {
          const key = `${item.name}||${item.location}||${item.message}`;
          if (s.has(key)) return false;
          s.add(key);
          return true;
        });
        // Sort by most recent first
        finalList.sort((a, b) => {
          const dateA = a.created_at ? new Date(a.created_at).getTime() : 0;
          const dateB = b.created_at ? new Date(b.created_at).getTime() : 0;
          return dateB - dateA;
        });
        console.log('Merged list:', finalList);
        renderList(listEl, finalList);
      })
      .catch(err => {
        console.warn('Fetch failed:', err.message);
        // If function not available, just keep the merged list
      });
  });
</script>
</head>
<body>
  <h1 class="gradient-text">The Board</h1>
<p style="color: #8b949e; text-align: center;">Hopefully this is the only list you're on.</p>

  <ul class="entries">
    <!-- Example entry – replace with real ones -->
    <li>
      <strong>Jamie</strong> – Austin, TX
      <div class="meta">Saw it on the subway – cool idea!</div>
    </li>
    <!-- Add more <li> here manually after checking Netlify dashboard -->
  </ul>

  <!-- <p style="text-align:center; margin-top:40px;">
    <a href="sign.html">← Back to sign</a> | <a href="index.html">Home</a>
  </p> -->
</body>
</html>